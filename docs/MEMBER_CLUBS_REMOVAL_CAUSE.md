# سبب حذف عضوية عضو من نادي (مثال: Best Padel)

## ملخص

**العضوية تُحذف من جدول `member_clubs` عندما يُحفظ "مصدر الحقيقة" (قائمة الأعضاء أو قائمة أعضاء النادي) دون أن يتضمّن ذلك العضو في النادي.** النظام لا يدمج العضويات القديمة مع الجديدة، بل **يستبدل** صفوف `member_clubs` بما يُرسَل في طلب الحفظ.

---

## كيف يعمل النظام في قاعدة البيانات

- جدول **`member_clubs`** يربط بين الأعضاء والنوادي (علاقة many-to-many).
- مصدر الحقيقة لـ "هل العضو في هذا النادي؟" يأتي من **واجهة التطبيق** عند استدعاء:
  - حفظ **الأعضاء** (مفتاح `all_members` أو `padel_members`)، أو
  - حفظ **النوادي** (مفتاح `admin_clubs`).

عند أي حفظ، الكود **يحذف** ثم **يعيد الإدراج** حسب البيانات المرسلة فقط، ولا يضيف تلقائياً عضويات موجودة سابقاً في `member_clubs` إذا لم تكن في الطلب.

---

## السببان المحتملان لحذف العضوية

### 1) حفظ قائمة الأعضاء (saveMembers → POST /api/data مع all_members أو padel_members)

**الملف:** `server/db/normalizedData.js` — الدالة `saveMembersToNormalized`

```javascript
// لكل عضو يُحفظ:
await query('DELETE FROM member_clubs WHERE member_id = ?', [id])
for (const cid of clubIds) {
  if (cid) await query('INSERT IGNORE INTO member_clubs (member_id, club_id) VALUES (?, ?)', [id, cid])
}
```

- **مصدر `clubIds`:** القيمة المرسلة في الطلب (من الواجهة/الكاش) للعضو: `member.clubIds` أو `member.clubId`.
- **النتيجة:** أي نادي **غير موجود** في `clubIds` المرسلة يُزال ارتباطه بهذا العضو من `member_clubs`.

**متى يحدث ذلك عملياً؟**

- عند حفظ الأعضاء من لوحة إدارة المنصة أو من صفحة إدارة أعضاء نادي.
- إذا كانت البيانات المُحمّلة للعضو (من الـ API/الكاش) **لا تحتوي** على نادي "Best Padel" في `clubIds` — لأي سبب (كاش قديم، تحميل قائمة أعضاء نادي آخر فقط، خطأ في واجهة تجمع clubIds من مصدر ناقص).
- أو عند استدعاء **إزالة العضو من النادي** (`removeMemberFromClubs`) الذي يعدّل `clubIds` ثم يستدعي `saveMembers`، فيصل للـ API قائمة clubIds بدون Best Padel فيُحذف الصف من `member_clubs`.

---

### 2) حفظ قائمة النوادي (saveClubs → POST /api/data مع admin_clubs)

**الملف:** `server/db/normalizedData.js` — داخل حفظ النوادي (مثل `saveClubsToNormalized`)

```javascript
// لكل نادي يُحفظ:
const memberList = club.members || []
const memberIds = memberList.map(...).filter(Boolean)
await query('DELETE FROM member_clubs WHERE club_id = ?', [cid])
for (const mid of memberIds) {
  if (mid) await query('INSERT IGNORE INTO member_clubs (member_id, club_id) VALUES (?, mid], [cid])
}
```

- **مصدر العضوية:** قائمة `club.members` للنادي المرسلة في الطلب (معرفات الأعضاء فقط).
- **النتيجة:** أي عضو **غير موجود** في `club.members` المرسلة يُحذف ارتباطه بهذا النادي من `member_clubs`.

**متى يحدث ذلك عملياً؟**

- عند حفظ إعدادات نادي "Best Padel" أو تحديث بيانات النادي من لوحة إدارة النادي.
- إذا كانت قائمة `members` المُرسلة للنادي **لا تتضمّن** ذلك العضو (مثلاً واجهة تعرض/تُرسل أعضاء من مصدر ناقص، أو تمت إزالة العضو من القائمة قبل الحفظ).

---

## التحقق من قاعدة البيانات

### 1) التأكد من أن العضوية غير موجودة

على قاعدة **padel_db** (أو u502561206_padel_db):

```sql
-- استبدل MEMBER_ID و CLUB_ID بمعرف العضو ومعرف نادي Best Padel
SELECT * FROM member_clubs WHERE member_id = 'MEMBER_ID' AND club_id = 'CLUB_ID';
```

إذا لم يُرجع الصف أي سجل، فالعضوية مُحذوفة (أو لم تُدرَج أبداً).

### 2) معرفة معرف نادي Best Padel

```sql
SELECT id, name, name_ar FROM clubs WHERE name LIKE '%best%' OR name_ar LIKE '%بيست%' OR name LIKE '%padel%';
```

### 3) سجل التدقيق (إن وُجد)

جدول **`audit_log`** يسجّل عمليات INSERT/UPDATE/DELETE على الجداول. لا يوجد فيه حقل يربط مباشرة بـ `member_clubs` (الجدول المسجّل غالباً `members` أو `clubs`)، لكن يمكن مراجعة آخر تحديثات على العضو أو النادي:

```sql
SELECT * FROM audit_log
WHERE table_name IN ('members', 'clubs')
  AND (record_id = 'MEMBER_ID' OR record_id = 'CLUB_ID' OR club_id = 'CLUB_ID')
ORDER BY created_at DESC
LIMIT 20;
```

استبدل `MEMBER_ID` و `CLUB_ID` بمعرف العضو ومعرف نادي Best Padel.

---

## الخلاصة: لماذا حُذفت العضوية؟

- **السبب المباشر في الكود:** عند استدعاء حفظ **أعضاء** أو حفظ **نوادي**، النظام **يستبدل** صفوف `member_clubs` للعضو (أو للنادي) **فقط** بما يُرسَل في الطلب.
- **السبب الفعلي المحتمل** أحد التالي:
  1. **حفظ أعضاء** حيث كان العضو مُرسَلًا بدون Best Padel في `clubIds` (واجهة، كاش، أو إزالة من النادي عبر "إزالة من النادي").
  2. **حفظ نوادي** حيث كان نادي Best Padel مُرسَلًا وقائمة `members` لا تحتوي على ذلك العضو.
  3. **إزالة يدوية** من إدارة أعضاء النادي (زر "إزالة هذا العضو من النادي") ثم حفظ الأعضاء.

لا يوجد في النظام عملية تلقائية (Cron أو خلفية) تحذف من `member_clubs` دون استدعاء حفظ أعضاء أو نوادي أو إزالة يدوية.

---

## إعادة ربط العضو بالنادي (إن كان مبرمجاً)

- **للزائر (العضو السابق):** إذا دخل العضو إلى صفحة النادي وظهر له "انضم إلى النادي" رغم أنه كان مسجلاً سابقاً، تظهر له رسالة توجيهية: *"كنت عضواً سابقاً؟ حدّث الصفحة أو اطلب من إدارة النادي إعادة ربط العضوية."* — بعد أن يعيد الإدارة ربطه (أدناه)، يكفي أن يحدّث الصفحة أو يعيد تسجيل الدخول ليعود ظهوره كعضو.
- **إعادة يدوية من الواجهة:** إما إضافة العضو إلى النادي من لوحة إدارة أعضاء النادي (Best Padel)، أو التأكد من أن العضو يظهر في قائمة الأعضاء ثم حفظ النادي.
- **من قاعدة البيانات (للطوارئ):**

  ```sql
  INSERT IGNORE INTO member_clubs (member_id, club_id) VALUES ('MEMBER_ID', 'BEST_PADEL_CLUB_ID');
  ```

- **مزامنة تلقائية للأعضاء الذين لا يملكون أي نادي:**  
  استدعاء واجهة المزامنة إن وُجدت (مثل `/api/init-db/sync-member-clubs`) يضيف فقط أعضاء **بدون أي صف في `member_clubs`**؛ لا يعيد تلقائياً عضوية حُذفت لأن العضو ما زال له نوادي أخرى. لذلك إعادة العضوية لحالة "انضم سابقاً لـ Best Padel ثم حُذفت" تكون يدوية (واجهة أو INSERT أعلاه).

---

## الإصلاح المطبق (Merge بدل الاستبدال)

تم تعديل النظام كالتالي حتى لا تُحذف العضويات بالخطأ:

1. **حفظ الأعضاء (`saveMembersToNormalized`):** لم يعد يتم استبدال صفوف `member_clubs` بالكامل بقائمة الطلب فقط. يتم **دمج** النوادي الحالية في قاعدة البيانات مع نوادي الطلب: `mergedClubIds = اتحاد(الحالي من DB، الطلب)`. ثم تُحدَّث الصفوف حسب `mergedClubIds`. بهذا لا تُحذف عضويات موجودة في DB إذا كانت الطلبات ناقصة.
2. **حفظ النوادي (`saveClubsToNormalized`):** نفس الفكرة: دمج قائمة الأعضاء الحالية للنادي مع قائمة الطلب، ثم تحديث `member_clubs` حسب القائمة المدمجة. **إضافة:** إذا أتى الطلب بقائمة أعضاء النادي **فارغة** بينما في قاعدة البيانات يوجد أعضاء لهذا النادي (مثلاً عند حذف حجز فقط دون تغيير الأعضاء)، لا يتم مسح `member_clubs` لهذا النادي — تُترك العضويات كما هي.
3. **إزالة العضو من النادي (مقصودة):** تمت إضافة API صريحة `POST /api/data/member-remove-from-club` مع `{ memberId, clubId }` التي تنفّذ `DELETE FROM member_clubs WHERE member_id=? AND club_id=?`. واجهة "إزالة العضو من النادي" تستدعي هذا الـ API أولاً ثم تحدّث الكاش عبر `saveMembers`.

بهذا لا تُحذف أي عضوية إلا عبر استدعاء صريح لـ "إزالة العضو من النادي" أو حذف العضو/النادي نهائياً.

### سبب محتمل: حذف حجوزات قديمة للعضو

عند **حذف حجز** (من إدارة الحجوزات أو من "حجوزاتي") يُستدعى `deleteBookingFromClub` ثم `saveClubs` بقائمة نوادي محدّثة (بدون ذلك الحجز فقط). إذا كانت قائمة أعضاء النادي في الطلب ناقصة أو فارغة (مثلاً بسبب كاش قديم أو `syncMembersToClubs`)، الإصلاح أعلاه (البند 2) يمنع مسح عضويات النادي عندما الطلب يحتوي على قائمة أعضاء فارغة والـ DB تحتوي على أعضاء.
